name: Test python pr

on:
  workflow_dispatch:
    inputs:
      repository:
        description: 'Repository name in the format owner/repo'
        required: true
      pr_number:
        description: 'Pull Request number'
        required: true

jobs:
  analyze:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repository }}
          ref: refs/pull/${{ inputs.pr_number }}/head

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f test-requirements.txt ]; then pip install -r test-requirements.txt; fi
          pip install pytest pytest-cov mutmut pytest-smell flake8

      - name: Compilation check (syntax validation)
        id: compilation
        continue-on-error: true
        run: |
          echo "### Compilation Check" >> $GITHUB_STEP_SUMMARY
          if python -m compileall -q .; then
            echo "Success: No syntax errors." >> $GITHUB_STEP_SUMMARY
          else
            echo "Failure: Syntax errors found." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Run linting (flake8)
        id: linting
        continue-on-error: true
        run: |
          echo "### Linting Results" >> $GITHUB_STEP_SUMMARY
          flake8 . >> $GITHUB_STEP_SUMMARY || echo "Linting failed with issues above." >> $GITHUB_STEP_SUMMARY

      - name: Run tests with coverage
        id: tests
        continue-on-error: true
        run: |
          echo "### Test Execution and Coverage" >> $GITHUB_STEP_SUMMARY
          pytest --cov=. --cov-report=term-missing >> $GITHUB_STEP_SUMMARY 2>&1
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Mutation testing
        id: mutation
        continue-on-error: true
        run: |
          echo "### Mutation Testing" >> $GITHUB_STEP_SUMMARY
          mutmut run --runner "pytest --cov=." >> $GITHUB_STEP_SUMMARY 2>&1
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Detect test smells
        id: smells
        continue-on-error: true
        run: |
          echo "### Test Smells Detection" >> $GITHUB_STEP_SUMMARY
          pytest-smell --ci >> $GITHUB_STEP_SUMMARY 2>&1
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Overall Summary
        run: |
          echo "## Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Compilation: ${{ steps.compilation.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- Linting: ${{ steps.linting.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- Tests: ${{ steps.tests.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- Mutation: ${{ steps.mutation.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- Test Smells: ${{ steps.smells.outcome }}" >> $GITHUB_STEP_SUMMARY

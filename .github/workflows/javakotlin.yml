name: PR Test Analysis Workflow

on:
  workflow_dispatch:
    inputs:
      repo_name:
        description: "Repository name (e.g. owner/repo)"
        required: true
        type: string
      pr_number:
        description: "Pull Request number"
        required: true
        type: string
      java_version:
        description: "Java version to use"
        required: false
        default: "21"
        type: string

jobs:
  analyze-pr:
    runs-on: ubuntu-latest
    steps:
      # Checkout base repo
      - name: Checkout base repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event.inputs.repo_name }}
          path: base
          fetch-depth: 0

      # Fetch PR test files
      - name: Fetch PR test files
        run: |
          git clone https://github.com/${{ github.event.inputs.repo_name }} pr_repo
          cd pr_repo
          git fetch origin pull/${{ github.event.inputs.pr_number }}/head:pr_branch
          git checkout pr_branch
          mkdir -p ../tests
          rsync -av --include='*/' --include='**/*Test*.java' --include='**/*Test*.kt' --exclude='*' ./ ../tests/
          cd ..
          echo "Test files copied to ./tests"

      # Install JDK
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ github.event.inputs.java_version }}

      # Build base repo
      - name: Build base project
        working-directory: base
        run: |
          if [ -f "mvnw" ] || [ -f "pom.xml" ]; then
            ./mvnw clean install -DskipTests || mvn clean install -DskipTests
          elif [ -f "gradlew" ] || [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
            ./gradlew build -x test || gradle build -x test
          else
            echo "No supported build tool found (Maven/Gradle)." && exit 1
          fi

      # Copy PR tests into base repo
      - name: Copy PR tests into base repo
        run: rsync -av ./tests/ ./base/src/test/

      # Run tests with coverage (JaCoCo)
      - name: Run Tests with Coverage
        working-directory: base
        run: |
          if [ -f "mvnw" ] || [ -f "pom.xml" ]; then
            ./mvnw test jacoco:report || mvn test jacoco:report
          else
            ./gradlew test jacocoTestReport || gradle test jacocoTestReport
          fi

      # Run mutation testing with PIT
      - name: Run Mutation Tests
        working-directory: base
        run: |
          if [ -f "mvnw" ] || [ -f "pom.xml" ]; then
            ./mvnw org.pitest:pitest-maven:mutationCoverage || mvn org.pitest:pitest-maven:mutationCoverage
          else
            ./gradlew pitest || gradle pitest
          fi

      # Detect test smells with TSDetect
      - name: Install TSDetect
        run: |
          curl -L https://github.com/TestSmells/TSDetect/releases/download/v1.0/TSDetect-1.0.jar -o tsdetect.jar

      - name: Run TSDetect
        run: |
          java -jar tsdetect.jar -p ./base/src/test -o ./base/tsdetect-report.json || echo "TSDetect failed"

      # Collect Results
      - name: Collect Reports
        run: |
          mkdir -p reports
          find base -name "jacoco.xml" -exec cp {} reports/coverage.xml \; || true
          find base -name "mutations.xml" -exec cp {} reports/mutation.xml \; || true
          find base -name "TEST-*.xml" -exec cp {} reports/ \; || true
          cp base/tsdetect-report.json reports/tsdetect.json || true

      # Generate summary
      - name: Generate Summary
        run: |
          echo "## Test Results Summary" > summary.md
          echo "### Compilation & Execution" >> summary.md
          echo "- âœ… Build succeeded" >> summary.md
          echo "### Coverage" >> summary.md
          if [ -f reports/coverage.xml ]; then
            COVERAGE=$(xmllint --xpath 'string(//report/counter[@type="INSTRUCTION"]/@covered)' reports/coverage.xml 2>/dev/null || echo "N/A")
            echo "- Coverage: $COVERAGE instructions covered" >> summary.md
          else
            echo "- Coverage: Not available" >> summary.md
          fi
          echo "### Mutation Testing" >> summary.md
          if [ -f reports/mutation.xml ]; then
            MUT_SCORE=$(xmllint --xpath 'string(//mutationMatrix/@score)' reports/mutation.xml 2>/dev/null || echo "N/A")
            echo "- Mutation Score: $MUT_SCORE" >> summary.md
          else
            echo "- Mutation Score: Not available" >> summary.md
          fi
          echo "### Test Smells" >> summary.md
          if [ -f reports/tsdetect.json ]; then
            echo "- TSDetect report generated" >> summary.md
          else
            echo "- Test Smells: Not available" >> summary.md
          fi

      # Upload artifacts
      - name: Upload Reports
        uses: actions/upload-artifact@v4
        with:
          name: pr-analysis-reports
          path: |
            reports/
            summary.md
